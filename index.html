<!DOCTYPE html>
<style>
 @import url("https://fonts.googleapis.com/css2?family=Prata&display=swap");
  
  body {
    text-align: center;
    background-color: blue;
    font-family: "Prata", serif;
    font-style: italic;
  }
  
  #musBtn {
    background-color: white;
    color: black;
  }
  
  #header {
    color: white;
    font-size: 75px;
  }
  
  #header2 {
    color: white;
    font-size: 28px;
  }
  
  #buto {
    text-align: center;
    color: white;
    font-size: 60px;
    margin: 0;
  	position: inline-block;
  	top: 75%;
  	-ms-transform: translateY(-75%);
  	transform: translateY(-75%);
  }

  #speaker {
    color: white;
    font-size: 30px;
  }

</style>

<html lang="en-US">
	<h1 id="header"></h1>
  <h3 id="header2"></h3>
  <br><br><br>
  <img id="image" width="400px" alt="gif depicting the weather">
  <br><br><br>
  <p id="speaker"></p>
  <div id="buto">
    " <input type="button" id="musBtn" value="hear today">"
  </div>
</html>


<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tonal/browser/tonal.min.js"></script>
<script>
  //global weather variables

  let snow;
  let rain;
  let cloud;
  let tempVal;

  //weather function for determining text + gif and loading variables with weather data

 async function weatherService () {
   
   //retreiving weather info + location info 
  const gpsURL = 'https://location.services.mozilla.com/v1/geolocate?key=test'
  const gpsReq = await window.fetch(gpsURL)
  const gps = await gpsReq.json()
  const url = `https://api.weatherbit.io/v2.0/current?units=I&lat=${gps.location.lat}&lon=${gps.location.lng}&key=5c3c4259df534414b6c2ee063f50cead&`
  const req = await window.fetch(url)
  const info = await req.json()
  
  //converting temp and description info to strings
  const temp = JSON.stringify(info.data[0].temp)
  const descriptionObj = info.data[0].weather.description
  const description = JSON.stringify(descriptionObj)
  
  //updating sub-header with temp and description
  const head2 = document.getElementById("header2")
  head2.innerHTML = description + "<br>" + temp + "°"
  console.log(info)
   
  //generate gif based off of cloud/rain conditions
  const snowGifURL = 'https://www.animationsoftware7.com/img/agifs/snow02.gif'
  const rainGifURL = 'https://media3.giphy.com/media/Wmp1EOzVybWd13s5DB/giphy.gif?cid=6c09b952edmxxjg0mppraizn3dk5wq07cnbpi22m7xbgehkt&ep=v1_stickers_related&rid=giphy.gif&ct=s'
  const cloudyGifURL = 'https://i.gifer.com/3F3I.gif'
  const sunnyGifURL = 'https://media1.giphy.com/media/aL1WOMnoxfC8w/giphy.gif'
  snow = info.data[0].snow
  rain = info.data[0].precip
  cloud = info.data[0].clouds
  tempVal = info.data[0].temp
  const centerImg = document.getElementById("image")
  
  if (snow > 0.04) {
    centerImg.src = snowGifURL;
  } else if (rain > 0.1) {
    centerImg.src = rainGifURL;
 	} else if (cloud > 55) {
    centerImg.src = cloudyGifURL;
  } else {
    centerImg.src = sunnyGifURL
  }
  
  
   
} 

function greet () {
  const hr = (new Date()).getHours();
  const head = document.getElementById("header");
  
  let greeting = {}  
  	if (hr < 12) {
    greeting = "good morning";
  } else if (hr < 17) {
    greeting = "good afternoon";
  } else {
    greeting = "good evening";
  }
  head.innerHTML = greeting;
}
  
/////////////////////////////////SOUND///////////////////////////////////
  
const synth = new Tone.Synth().toDestination();
const playBTN = document.getElementById("musBtn");
const speaker = document.getElementById("speaker");

let scaleLead;
let scaleChord;
let scaleBass;
let noteList;
let scaleNote;

let mixer;

let osc1;
let osc2;
let syn1;
let syn2;

let lfo1;
let lfo2;
let lfo3;

let loop1;
 

function emptySpeaker () {
  speaker.innerHTML = ""
}

function musicPlays () {
  if (speaker.innerHTML === "") {
    speaker.innerHTML = "♬"
    osc1.start();
    osc2.start();
    lfo1.start();
    lfo2.start();
    lfo3.start();
    loop1.start();
    Tone.Transport.start();
  } else  {
    speaker.innerHTML = ""
    osc1.stop();
    osc2.stop();
    lfo1.stop();
    lfo2.stop();
    lfo3.stop();
    loop1.stop();
    Tone.Transport.stop();
  }
  }



//master

function toneControl () {
  Tone.Master.volume.value = -30;
}

function loopStep (time) {
  let random = Math.floor(Math.random() * scaleLead.length);
  let note = scaleLead[random];
  syn1.triggerAttackRelease(note, "8n", time);
}

function loopControl () {
  loop1 = new Tone.Loop(loopStep, "4n");
}

//sound generators

function oscillo1 () {
  osc1 = new Tone.Oscillator({
      type: "triangle",
      frequency: `${scaleBass[4]}`,
      volume: 0,
    }
  );
  osc1.connect(mixer);

}

function oscillo2 () {
  osc2 = new Tone.Oscillator({
    type: "sine",
    frequency: `${scaleBass[0]}`,
    volume: 0,
  }
  );
  osc2.connect(mixer);
}

function synth1 () {
  syn1 = new Tone.Synth();
  syn1.oscillator.type = 'square';
  syn1.connect(mixer);
}

//lfo/effects

function lowFreqOsc1 () {
  lfo1 = new Tone.LFO("0.05hz", 0, 5);
  lfo2 = new Tone.LFO("0.08hz", 0, 5);
  lfo3 = new Tone.LFO("0.01hz", 1, 5);
  lfo1.connect(osc1.volume); 
  lfo2.connect(osc2.volume);
  lfo3.connect(syn1.volume);
}
 
//mixer

function mix () {
  mixer = new Tone.Gain();
  mixer.connect(Tone.Master);
//reverb
  let reverb = new Tone.Reverb({
      wet: 1,
      decay: 10,
     }
  );
  mixer.connect(reverb);
  reverb.connect(Tone.Master);
}

//scale set up

function scaleGen () {
  //rainy/snowy creates minor scale, cloudy/sunny creates major scale
  let minMaj;
  if (snow > 0.04) {
    minMaj = "minor";
  } else if (rain > 0.1) {
    minMaj = "minor";
 	} else if (cloud > 55) {
    minMaj = "major";
  } else {
    minMaj = "major";
  }
  //note names
  noteList = ["A","A#","B","B#","C","D","D#","E","E#","F","F#","G"];
  let random2 = Math.floor(Math.random() * noteList.length); //currently random <- this needs to be fixed to pick root note based off weather!
  scaleNote = noteList[random2];
  scaleLead = Tonal.Scale.get(`${scaleNote}4 ${minMaj}`).notes;
  scaleChord = Tonal.Scale.get(`${scaleNote}4 ${minMaj}`).notes;
  scaleBass = Tonal.Scale.get(`${scaleNote}3 ${minMaj}`).notes;
}

//set up on load

function init () {
//front end 
  greet();
  weatherService();
  emptySpeaker();
//mixer setup
mix();
//scale gen
scaleGen();
//load sounds
oscillo1();
oscillo2();
synth1();
lowFreqOsc1();
//master
toneControl();
loopControl();
}

window.addEventListener('load', init)
playBTN.addEventListener('click', musicPlays)
playBTN.addEventListener("click", () => {
  if (Tone.context.state !== "running") {
    Tone.start();
  }
}
)
</script>